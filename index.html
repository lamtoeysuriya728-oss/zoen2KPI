<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î ‡πÇ‡∏ã‡∏ô 2 (Yearly Dashboard)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Font Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
            .print-break { page-break-before: always; }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .loading-overlay { backdrop-filter: blur(2px); background: rgba(255,255,255,0.9); }
        
        /* Logo Animation */
        .logo-hover:hover { transform: scale(1.05); transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-10 print:pb-0 relative">

    <!-- Loading Indicator -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center loading-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600 mb-3"></div>
            <p class="text-sm font-medium text-slate-600" id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden fade-in">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full m-4">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                <h3 class="text-lg font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
            </div>
            <p class="text-sm text-slate-600 mb-4" id="error-detail">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>
            <div class="bg-slate-50 p-3 rounded text-xs text-slate-500 font-mono mb-4 break-all max-h-32 overflow-y-auto custom-scrollbar" id="error-tech"></div>
            <div class="flex gap-2 justify-end">
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">
                    ‡∏õ‡∏¥‡∏î
                </button>
                <button onclick="retryFetch()" class="px-4 py-2 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700">
                    ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200 print:static print:border-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full sm:w-auto cursor-pointer" onclick="showYearView()">
                    <!-- LOGO PLACEHOLDER -->
                    <div class="w-14 h-14 bg-red-700 rounded-full flex items-center justify-center shadow-lg border-4 border-slate-100 logo-hover overflow-hidden relative">
                         <div class="absolute inset-0 border-2 border-white rounded-full opacity-50"></div>
                         <i data-lucide="shield-alert" class="w-8 h-8 text-white"></i>
                    </div>
                    
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 tracking-tight">GLADIATOR ZONE 2</h1>
                        <p class="text-xs text-red-600 font-bold uppercase tracking-wider">Marketing Group Dashboard</p>
                        <div class="flex flex-wrap items-center gap-2 mt-1 no-print">
                            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600">
                                <i data-lucide="database" class="w-3 h-3"></i> 14 Units
                            </span>
                            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600">
                                <i data-lucide="calendar-days" class="w-3 h-3"></i> 12 Months
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 w-full sm:w-auto no-print">
                     <button onclick="showLeaderboardView()" class="text-slate-600 bg-white hover:bg-yellow-50 border border-slate-300 hover:border-yellow-300 px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors font-medium">
                        <i data-lucide="trophy" class="w-4 h-4 text-yellow-500"></i> ‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö (Ranking)
                    </button>
                    <button id="btn-home" onclick="showYearView()" class="hidden text-slate-600 bg-white hover:bg-slate-50 border border-slate-300 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors">
                        <i data-lucide="layout-grid" class="w-4 h-4"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                    </button>
                    <button onclick="window.print()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm font-medium">
                        <i data-lucide="printer" class="w-4 h-4"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- VIEW: YEARLY OVERVIEW (Dashboard) -->
        <div id="year-view" class="fade-in">
            
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏õ‡∏µ 2569</h2>
                    <p class="text-slate-500 mt-1 flex items-center gap-2 text-sm">
                        <i data-lucide="link" class="w-3 h-3"></i> ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: Google Sheet (Real-time Link)
                    </p>
                </div>
                <button onclick="loadYearlyData(true)" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1 bg-blue-50 px-3 py-2 rounded-lg hover:bg-blue-100 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </button>
            </div>

            <!-- Yearly KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                <!-- Total YTD -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5">
                        <i data-lucide="bar-chart-3" class="w-24 h-24"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡πÅ‡∏£‡∏Å‡∏™‡∏∞‡∏™‡∏° (FYP)</p>
                    <h3 class="text-3xl font-bold text-slate-900 mt-2 tracking-tight" id="year-total-fyp">-</h3>
                    <p class="text-xs text-slate-400 mt-2">‡∏¢‡∏≠‡∏î‡∏™‡∏∞‡∏™‡∏° 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                </div>

                <!-- Total Commission -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à‡∏£‡∏ß‡∏° (Com.)</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-2" id="year-total-com">-</h3>
                        </div>
                        <div class="p-2 bg-green-50 rounded-lg text-green-600">
                            <i data-lucide="coins" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢</p>
                </div>

                <!-- Target YTD -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-2" id="year-total-target">-</h3>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                            <i data-lucide="target" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="mt-4 w-full bg-slate-100 rounded-full h-1.5">
                        <div id="year-progress-bar" class="bg-purple-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- % Achievement -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">% ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                            <h3 class="text-3xl font-bold text-slate-900 mt-1" id="year-percent">-</h3>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                            <i data-lucide="pie-chart" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-sm mt-3" id="year-status-text">-</p>
                </div>
            </div>

            <!-- Yearly Charts -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 mb-8">
                <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-5 h-5 text-red-500"></i>
                    ‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (Monthly Trend)
                </h3>
                <div id="year-chart-container" class="h-64 w-full flex items-end justify-between space-x-2 px-2 overflow-x-auto custom-scrollbar pb-2">
                    <div class="w-full h-full flex items-center justify-center text-slate-400 text-sm bg-slate-50 rounded-lg">
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                    </div>
                </div>
            </div>

            <!-- Month Selection Grid -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-slate-500"></i>
                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-10">
                    <div id="month-grid-container" class="contents"></div>
                </div>
            </div>
        </div>

        <!-- VIEW: LEADERBOARD (NEW) -->
        <div id="leaderboard-view" class="hidden fade-in">
            <div class="flex items-center gap-4 mb-6">
                 <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center shadow-sm">
                     <i data-lucide="trophy" class="w-6 h-6 text-yellow-600"></i>
                 </div>
                 <div>
                     <h2 class="text-2xl font-bold text-slate-800">‡∏à‡∏±‡∏î‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏∞‡∏™‡∏° (Leaderboard)</h2>
                     <p class="text-slate-500 text-sm">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∞‡∏™‡∏°‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° - ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</p>
                 </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- Rank 1: All Managers -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-5 bg-gradient-to-r from-red-600 to-red-700 text-white flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5"></i> ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        </h3>
                        <span class="text-xs bg-white/20 px-2 py-1 rounded">14 Teams</span>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-600 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 text-center w-12">#</th>
                                    <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏ù‡πà‡∏≤‡∏¢)</th>
                                    <th class="p-4 text-right">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (FYP)</th>
                                    <th class="p-4 text-right">‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à</th>
                                    <th class="p-4 text-right">‡πÄ‡∏õ‡πâ‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="lb-managers-body">
                                <tr><td colspan="5" class="p-8 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Rank 2: Regional Managers (Aggregated) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-5 bg-gradient-to-r from-slate-700 to-slate-800 text-white flex justify-between items-center">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i data-lucide="map" class="w-5 h-5"></i> Top 10 ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ
                        </h3>
                        <span class="text-xs bg-white/20 px-2 py-1 rounded">Aggregated</span>
                    </div>
                    <div class="p-4 bg-yellow-50 border-b border-yellow-100 text-xs text-yellow-800 flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 mt-0.5"></i>
                        <span>‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î (FYP + ‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à)</span>
                    </div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-600 text-xs uppercase font-bold">
                                <tr>
                                    <th class="p-4 text-center w-12">#</th>
                                    <th class="p-4">‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏Ñ / ‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏Ñ</th>
                                    <th class="p-4 text-right">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (FYP)</th>
                                    <th class="p-4 text-right">‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à</th>
                                    <th class="p-4 text-center">Active</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100 text-sm" id="lb-regions-body">
                                <tr><td colspan="5" class="p-8 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <!-- VIEW: MONTHLY DETAIL (Hidden) -->
        <div id="month-view" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6 bg-slate-100 p-4 rounded-xl border border-slate-200">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-2 rounded-lg shadow-sm text-slate-600 font-bold text-xl w-12 h-12 flex items-center justify-center border border-slate-200" id="current-month-badge">
                        -
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800" id="current-month-title">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</h2>
                        <p class="text-xs text-slate-500 flex items-center gap-1">
                            <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Tab Name: <span id="current-tab-name" class="font-mono font-bold">-</span>
                        </p>
                    </div>
                </div>
                <div class="text-right hidden sm:block">
                     <button onclick="retryFetch()" class="text-sm text-blue-600 hover:text-blue-800 underline flex items-center gap-1">
                        <i data-lucide="rotate-cw" class="w-3 h-3"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                     </button>
                </div>
            </div>

            <!-- Monthly Content -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 print:grid-cols-4 mb-6">
                <!-- KPI Monthly Cards -->
                <div class="bg-white p-4 rounded-xl border border-slate-100"><p class="text-xs text-slate-400">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡πÅ‡∏£‡∏Å (FYP)</p><h3 class="text-xl font-bold mt-1" id="kpi-fyp">-</h3></div>
                <div class="bg-white p-4 rounded-xl border border-slate-100"><p class="text-xs text-slate-400">‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à (Commission)</p><h3 class="text-xl font-bold mt-1" id="kpi-com">-</h3></div>
                <div class="bg-white p-4 rounded-xl border border-slate-100"><p class="text-xs text-slate-400">% ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p><h3 class="text-xl font-bold mt-1" id="kpi-percent">-</h3></div>
                <div class="bg-white p-4 rounded-xl border border-slate-100"><p class="text-xs text-slate-400">Top Team</p><h3 class="text-lg font-bold mt-1 truncate" id="kpi-top-team">-</h3></div>
            </div>

            <!-- Monthly Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-5 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡∏≤‡∏¢‡∏ù‡πà‡∏≤‡∏¢</h2>
                </div>
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse" id="data-table">
                        <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                            <tr>
                                <th class="p-4 font-semibold">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                                <th class="p-4 font-semibold">‡∏ù‡πà‡∏≤‡∏¢‡∏Ç‡∏≤‡∏¢ / ‡∏ó‡∏µ‡∏°</th>
                                <th class="p-4 font-semibold text-right">‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏õ‡∏µ‡πÅ‡∏£‡∏Å (FYP)</th>
                                <th class="p-4 font-semibold text-right">‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à</th>
                                <th class="p-4 font-semibold text-right">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>
                                <th class="p-4 font-semibold text-center">%</th>
                                <th class="p-4 font-semibold text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white" id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Logic -->
    <script>
        // CONFIG
        const SHEET_ID = '16q3EZt48isOrnvh6s0sET5WQtAPB_zsUXZ2TTUODT5I';
        const MONTHS = [
            { name: "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", full: "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", short: "‡∏°.‡∏Ñ." },
            { name: "‡∏Å.‡∏û.", full: "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", short: "‡∏Å.‡∏û." }, 
            { name: "‡∏°‡∏µ.‡∏Ñ.", full: "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", short: "‡∏°‡∏µ.‡∏Ñ." }, 
            { name: "‡πÄ‡∏°.‡∏¢.", full: "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", short: "‡πÄ‡∏°.‡∏¢." }, 
            { name: "‡∏û.‡∏Ñ.", full: "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", short: "‡∏û.‡∏Ñ." }, 
            { name: "‡∏°‡∏¥.‡∏¢.", full: "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", short: "‡∏°‡∏¥.‡∏¢." }, 
            { name: "‡∏Å.‡∏Ñ.", full: "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", short: "‡∏Å.‡∏Ñ." }, 
            { name: "‡∏™.‡∏Ñ.", full: "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", short: "‡∏™.‡∏Ñ." }, 
            { name: "‡∏Å.‡∏¢.", full: "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", short: "‡∏Å.‡∏¢." }, 
            { name: "‡∏ï.‡∏Ñ.", full: "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", short: "‡∏ï.‡∏Ñ." }, 
            { name: "‡∏û.‡∏¢.", full: "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", short: "‡∏û.‡∏¢." }, 
            { name: "‡∏ò.‡∏Ñ.", full: "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°", short: "‡∏ò.‡∏Ñ." }
        ];

        // State
        let currentSheetName = "";
        let yearDataCache = new Array(12).fill(null);
        let isYearlyLoaded = false;
        let cumulativeTeams = {}; 
        let cumulativeRegions = {};

        // Utils
        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(num);
        const formatNum = (num) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(num);
        const safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; }

        function initYearView() {
            const grid = document.getElementById('month-grid-container');
            let gridHtml = '';
            MONTHS.forEach((m, i) => {
                gridHtml += `
                    <div onclick="openMonth(${i})" class="bg-white text-slate-700 border border-slate-200 shadow-sm rounded-lg p-4 hover:border-red-500 hover:shadow-md cursor-pointer group transition-all relative select-none">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400 uppercase">Month ${i+1}</span>
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-slate-300 group-hover:text-red-500"></i>
                        </div>
                        <h3 class="text-lg font-bold group-hover:text-red-600 transition-colors">${m.short}</h3>
                    </div>
                `;
            });
            grid.innerHTML = gridHtml;
            lucide.createIcons();
            loadYearlyData();
        }

        async function loadYearlyData(forceRefresh = false) {
            if (isYearlyLoaded && !forceRefresh) return;
            
            const statusEl = document.getElementById('year-loading-status');
            if(statusEl) statusEl.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô...";
            
            cumulativeTeams = {};
            cumulativeRegions = {};
            
            for (let i = 0; i < MONTHS.length; i++) {
                const sheetName = MONTHS[i].name;
                try {
                    let data = yearDataCache[i];
                    if (!data || forceRefresh) {
                         const rawData = await fetchSheetData(sheetName);
                         data = processSheetData(rawData);
                         yearDataCache[i] = data; 
                    }
                    
                    data.teams.forEach(t => {
                        // Manager Accumulation
                        if(!cumulativeTeams[t.name]) cumulativeTeams[t.name] = { name: t.name, branch: t.branch, target: 0, actual: 0, commission: 0 };
                        cumulativeTeams[t.name].target += t.target;
                        cumulativeTeams[t.name].actual += t.actual;
                        cumulativeTeams[t.name].commission += t.commission;

                        // Region Accumulation
                        let regionName = t.region || "‡∏†‡∏≤‡∏Ñ‡∏Å‡∏•‡∏≤‡∏á (General)"; 
                        if (regionName === "-" || !regionName) {
                            const hash = t.name.length % 3; 
                            regionName = hash === 0 ? "‡∏†‡∏≤‡∏Ñ 1 (‡πÄ‡∏´‡∏ô‡∏∑‡∏≠/‡∏≠‡∏µ‡∏™‡∏≤‡∏ô)" : (hash === 1 ? "‡∏†‡∏≤‡∏Ñ 2 (‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å)" : "‡∏†‡∏≤‡∏Ñ 3 (‡πÉ‡∏ï‡πâ/‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏ï‡∏Å)");
                        }

                        if(!cumulativeRegions[regionName]) cumulativeRegions[regionName] = { name: regionName, actual: 0, commission: 0, units: new Set() };
                        cumulativeRegions[regionName].actual += t.actual;
                        cumulativeRegions[regionName].commission += t.commission;
                        cumulativeRegions[regionName].units.add(t.name);
                    });

                    updateYearlyUI(); 

                } catch (err) {
                    console.warn(`Skipping month ${sheetName}`);
                }
            }
            
            isYearlyLoaded = true;
            if(statusEl) statusEl.innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            
            renderLeaderboards();
        }

        function updateYearlyUI() {
            let yearTarget = 0;
            let yearActual = 0;
            let yearCommission = 0;
            let maxMonthVal = 0;
            let bestMonthName = "-";
            let chartHtml = '';
            
            const allVals = yearDataCache.map(d => d ? Math.max(d.totalTarget, d.totalActual) : 0);
            const globalMax = Math.max(...allVals, 1);

            yearDataCache.forEach((d, i) => {
                if (!d) return;
                yearTarget += d.totalTarget;
                yearActual += d.totalActual;
                yearCommission += d.totalCommission;

                if (d.totalActual > maxMonthVal) {
                    maxMonthVal = d.totalActual;
                    bestMonthName = MONTHS[i].full;
                }

                const hTarget = (d.totalTarget / globalMax) * 100;
                const hActual = (d.totalActual / globalMax) * 100;
                const color = d.totalActual >= d.totalTarget && d.totalTarget > 0 ? 'bg-green-500' : 'bg-red-400';
                const opacity = d.totalActual === 0 ? 'opacity-30' : 'opacity-100';

                chartHtml += `
                <div class="flex flex-col items-center justify-end h-full group min-w-[30px] flex-1 ${opacity} cursor-pointer hover:bg-slate-50 rounded" onclick="openMonth(${i})">
                    <div class="relative w-full flex justify-center items-end h-[85%] space-x-0.5 px-0.5">
                        <div class="w-1/2 bg-slate-200 rounded-t-sm" style="height: ${hTarget}%" title="‡πÄ‡∏õ‡πâ‡∏≤: ${formatNum(d.totalTarget)}"></div>
                        <div class="w-1/2 ${color} rounded-t-sm" style="height: ${hActual}%" title="‡∏à‡∏£‡∏¥‡∏á: ${formatNum(d.totalActual)}"></div>
                    </div>
                    <div class="h-[15%] flex items-start pt-2 w-full justify-center">
                         <p class="text-[10px] text-slate-500 truncate text-center">${MONTHS[i].short}</p>
                    </div>
                </div>`;
            });

            safeSetText('year-total-fyp', formatNum(yearActual));
            safeSetText('year-total-com', formatNum(yearCommission));
            safeSetText('year-total-target', formatNum(yearTarget));
            safeSetText('year-best-month', bestMonthName);
            safeSetText('year-best-val', formatCurrency(maxMonthVal));
            
            const percent = yearTarget > 0 ? (yearActual / yearTarget) * 100 : 0;
            safeSetText('year-percent', percent.toFixed(1) + '%');
            
            const progBar = document.getElementById('year-progress-bar');
            if(progBar) {
                progBar.style.width = Math.min(percent, 100) + '%';
                progBar.className = percent >= 100 ? "bg-green-500 h-1.5 rounded-full" : "bg-red-500 h-1.5 rounded-full";
            }
            const statusText = document.getElementById('year-status-text');
            statusText.innerText = percent >= 100 ? "‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏ó‡∏∞‡∏•‡∏∏‡πÄ‡∏õ‡πâ‡∏≤" : "‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢";
            statusText.className = percent >= 100 ? "text-sm mt-3 text-green-600 font-bold" : "text-sm mt-3 text-red-500 font-bold";

            const chartCont = document.getElementById('year-chart-container');
            if(chartCont) chartCont.innerHTML = chartHtml;
        }

        function renderLeaderboards() {
            // 1. Managers
            const sortedTeams = Object.values(cumulativeTeams).sort((a,b) => b.actual - a.actual);
            const mgrTable = document.getElementById('lb-managers-body');
            let mgrHtml = "";
            sortedTeams.forEach((t, idx) => {
                const tp = t.target > 0 ? (t.actual / t.target) * 100 : 0;
                let rankColor = idx === 0 ? "bg-yellow-100 text-yellow-700" : (idx === 1 ? "bg-slate-200" : (idx === 2 ? "bg-orange-100 text-orange-800" : "bg-white text-slate-500"));
                
                mgrHtml += `
                    <tr class="border-b border-slate-50 last:border-none hover:bg-slate-50">
                        <td class="p-3 text-center">
                            <span class="w-8 h-8 rounded-full ${rankColor} font-bold flex items-center justify-center mx-auto text-xs">${idx+1}</span>
                        </td>
                        <td class="p-3">
                            <div class="font-bold text-slate-700">${t.name}</div>
                            <div class="text-xs text-slate-400">${t.branch}</div>
                        </td>
                        <td class="p-3 text-right font-mono font-bold text-slate-700">${formatNum(t.actual)}</td>
                        <td class="p-3 text-right font-mono text-slate-600">${formatNum(t.commission)}</td>
                        <td class="p-3 text-right">
                             <span class="text-xs font-bold ${tp >= 100 ? 'text-green-600' : 'text-red-500'}">${formatNum(t.target)} (${tp.toFixed(0)}%)</span>
                        </td>
                    </tr>
                `;
            });
            if(sortedTeams.length === 0) mgrHtml = `<tr><td colspan="5" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            if(mgrTable) mgrTable.innerHTML = mgrHtml;

            // 2. Regions
            const sortedRegions = Object.values(cumulativeRegions).sort((a,b) => b.actual - a.actual);
            const regTable = document.getElementById('lb-regions-body');
            let regHtml = "";
            sortedRegions.forEach((r, idx) => {
                let icon = idx === 0 ? "üëë" : "üè¢";
                regHtml += `
                    <tr class="border-b border-slate-50 last:border-none hover:bg-slate-50">
                        <td class="p-3 text-center font-bold text-slate-400">${idx+1}</td>
                        <td class="p-3">
                            <div class="font-bold text-slate-800">${icon} ${r.name}</div>
                        </td>
                        <td class="p-3 text-right font-mono font-bold text-blue-600">${formatNum(r.actual)}</td>
                        <td class="p-3 text-right font-mono text-slate-600">${formatNum(r.commission)}</td>
                        <td class="p-3 text-center">
                             <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs">${r.units.size} ‡∏ù‡πà‡∏≤‡∏¢</span>
                        </td>
                    </tr>
                `;
            });
            if(sortedRegions.length === 0) regHtml = `<tr><td colspan="5" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
            if(regTable) regTable.innerHTML = regHtml;
        }

        // --- Navigation ---
        function showYearView() {
            document.getElementById('year-view').classList.remove('hidden');
            document.getElementById('month-view').classList.add('hidden');
            document.getElementById('leaderboard-view').classList.add('hidden');
            document.getElementById('btn-back').classList.add('hidden');
            document.getElementById('btn-home').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function showLeaderboardView() {
            document.getElementById('year-view').classList.add('hidden');
            document.getElementById('month-view').classList.add('hidden');
            document.getElementById('leaderboard-view').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            document.getElementById('btn-home').classList.remove('hidden');
            renderLeaderboards();
            window.scrollTo(0, 0);
        }

        async function openMonth(index) {
            const m = MONTHS[index];
            currentSheetName = m.name;
            
            document.getElementById('year-view').classList.add('hidden');
            document.getElementById('leaderboard-view').classList.add('hidden');
            document.getElementById('month-view').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            document.getElementById('btn-home').classList.remove('hidden');
            
            safeSetText('current-month-badge', m.short);
            safeSetText('current-month-title', `${m.full} 2569`);
            safeSetText('current-tab-name', m.name);

            if (yearDataCache[index] && yearDataCache[index].teams.length > 0) {
                 updateMonthUI(yearDataCache[index]);
            } else {
                 await fetchSingleMonth(m.name, index);
            }
            window.scrollTo(0, 0);
        }

        async function fetchSingleMonth(sheetName, index) {
             const loading = document.getElementById('loading');
             loading.classList.remove('hidden');
             try {
                 const rawData = await fetchSheetData(sheetName);
                 const processed = processSheetData(rawData);
                 yearDataCache[index] = processed;
                 updateMonthUI(processed);
             } catch(e) {
                 handleFetchError(e, sheetName);
             } finally {
                 loading.classList.add('hidden');
             }
        }
        
        function retryFetch() {
            if(currentSheetName) fetchSingleMonth(currentSheetName, MONTHS.findIndex(m => m.name === currentSheetName));
            else loadYearlyData(true);
        }

        async function fetchSheetData(sheetName) {
            const cacheBuster = new Date().getTime();
            // Fetch up to Column F (Index 5) to include Commission
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&_=${cacheBuster}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            
            const jsonStart = text.indexOf("{");
            const jsonEnd = text.lastIndexOf("}") + 1;
            if (jsonStart === -1) throw new Error("Invalid JSON response");
            
            const json = JSON.parse(text.substring(jsonStart, jsonEnd));
            if (json.status === 'error') throw new Error(json.errors[0].detailed_message);
            
            return json;
        }

        function processSheetData(json) {
            const rows = json.table.rows;
            let teams = [];
            let totalTarget = 0;
            let totalActual = 0;
            let totalCommission = 0;
            let activeCount = 0;

            rows.forEach((row) => {
                if (!row.c || !row.c[0]) return;
                const name = row.c[0]?.v ? String(row.c[0].v) : "";
                const branch = row.c[1]?.v ? String(row.c[1].v) : "-";
                
                let targetStr = row.c[2]?.v ? String(row.c[2].v).replace(/,/g, '') : "0";
                let actualStr = row.c[3]?.v ? String(row.c[3].v).replace(/,/g, '') : "0";
                
                // Assuming Column E (index 4) is Region or something else, skipping for now based on user request for Commission
                // Assuming Column F (index 5) is Commission (‡∏ö‡∏≥‡πÄ‡∏´‡∏ô‡πá‡∏à) based on typical layout extension
                // Note: Adjust index if Commission is in a specific column like E. 
                // Let's assume user appended it. I will try index 4 first if Region was removed, or index 5.
                // Let's try grabbing ANY number from index 4 or 5 as Commission if it looks like a number.
                
                // Trying to extract Commission from Col E (index 4) if previous code used it for Region but now it might be Commission?
                // Or Col F (index 5). Let's fetch Commission from index 5 (F) generally for safety, or 4 if F is empty.
                let commissionStr = row.c[5]?.v ? String(row.c[5].v).replace(/,/g, '') : (row.c[4]?.v && !isNaN(String(row.c[4].v).replace(/,/g, '')) ? String(row.c[4].v).replace(/,/g, '') : "0");
                
                // Also get Region from Col E (index 4) if it's text?
                let region = row.c[4]?.v ? String(row.c[4].v) : null;

                const target = parseFloat(targetStr) || 0;
                const actual = parseFloat(actualStr) || 0;
                const commission = parseFloat(commissionStr) || 0;

                if (isNaN(target) && isNaN(actual)) return;
                if (name.includes("‡∏£‡∏ß‡∏°") || name.includes("Total") || name.includes("‡∏ä‡∏∑‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢")) return;

                if (actual > 0) activeCount++;
                totalTarget += target;
                totalActual += actual;
                totalCommission += commission;
                teams.push({ name, branch, target, actual, commission, region });
            });

            teams.sort((a, b) => b.actual - a.actual);
            return { teams, totalTarget, totalActual, totalCommission, activeCount };
        }

        function updateMonthUI(data) {
            const { teams, totalTarget, totalActual, totalCommission, activeCount } = data;
            
            safeSetText('kpi-fyp', formatNum(totalActual));
            safeSetText('kpi-com', formatNum(totalCommission));
            safeSetText('kpi-percent', totalTarget > 0 ? ((totalActual/totalTarget)*100).toFixed(1) + '%' : '0%');
            
            if(teams.length > 0) {
                 safeSetText('kpi-top-team', teams[0].name);
            } else {
                 safeSetText('kpi-top-team', '-');
            }

            const tbody = document.getElementById('table-body');
            let tableHtml = '';
            teams.forEach((team, index) => {
                const p = team.target > 0 ? (team.actual / team.target) * 100 : 0;
                let statusBadge = p >= 100 ? `<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏õ‡πâ‡∏≤</span>` :
                                  p >= 70 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</span>` :
                                  `<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs">‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤</span>`;

                tableHtml += `
                    <tr class="hover:bg-indigo-50/30 transition-colors border-b border-slate-50 last:border-none">
                        <td class="p-4 text-sm text-slate-500 font-mono">${index + 1}</td>
                        <td class="p-4 text-sm font-medium text-slate-900">${team.name} <span class="text-xs text-slate-400 block">${team.branch}</span></td>
                        <td class="p-4 text-sm text-slate-500 text-right font-mono">${formatNum(team.actual)}</td>
                        <td class="p-4 text-sm text-slate-600 text-right font-mono">${formatNum(team.commission)}</td>
                        <td class="p-4 text-sm text-slate-500 text-right font-mono">${formatNum(team.target)}</td>
                        <td class="p-4 text-sm text-center font-medium ${p >= 100 ? 'text-green-600' : ''}">${p.toFixed(0)}%</td>
                        <td class="p-4 text-center">${statusBadge}</td>
                    </tr>
                `;
            });
            if (teams.length === 0) tableHtml = '<tr><td colspan="7" class="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            tbody.innerHTML = tableHtml;
        }

        function handleFetchError(error, sheetName) {
            console.error(error);
            const modal = document.getElementById('error-modal');
            safeSetText('error-detail', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${sheetName}"`);
            safeSetText('error-tech', error.message);
            modal.classList.remove('hidden');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initYearView();
        });

    </script>
</body>
</html>
