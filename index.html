<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปผลงานกลุ่มการตลาด โซน 2 (Yearly Dashboard)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Font Noto Sans Thai -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
            .print-break { page-break-before: always; }
        }
        
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .loading-overlay { backdrop-filter: blur(2px); background: rgba(255,255,255,0.9); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-10 print:pb-0 relative">

    <!-- Loading Indicator (Full Screen) -->
    <div id="loading" class="fixed inset-0 z-50 flex items-center justify-center loading-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-xl flex flex-col items-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
            <p class="text-sm font-medium text-slate-600" id="loading-text">กำลังเชื่อมต่อ Google Sheet...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden fade-in">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full m-4">
            <div class="flex items-center gap-3 text-red-600 mb-4">
                <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                <h3 class="text-lg font-bold">เกิดข้อผิดพลาด</h3>
            </div>
            <p class="text-sm text-slate-600 mb-4" id="error-detail">ไม่สามารถดึงข้อมูลได้</p>
            <div class="bg-slate-50 p-3 rounded text-xs text-slate-500 font-mono mb-4 break-all max-h-32 overflow-y-auto custom-scrollbar" id="error-tech"></div>
            <div class="flex gap-2 justify-end">
                <button onclick="document.getElementById('error-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-50 rounded-lg">
                    ปิด
                </button>
                <button onclick="retryFetch()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ลองใหม่
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200 print:static print:border-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 w-full sm:w-auto cursor-pointer" onclick="showYearView()">
                    <div class="p-2.5 bg-indigo-600 rounded-lg shadow-md text-white print:hidden hover:bg-indigo-700 transition-colors">
                        <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Dashboard กลุ่มการตลาด โซน 2</h1>
                        <div class="flex flex-wrap items-center gap-2 mt-1 no-print">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 border border-green-200">
                                <i data-lucide="wifi" class="w-3 h-3"></i> Real-time Data
                            </span>
                            <span class="text-xs text-gray-400">
                                ปี 2569
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 w-full sm:w-auto no-print">
                    <button id="btn-back" onclick="showYearView()" class="hidden text-slate-600 bg-white hover:bg-slate-50 border border-slate-300 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> กลับหน้าภาพรวม
                    </button>
                    <button onclick="window.print()" class="text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 px-3 py-2 rounded-lg text-sm flex items-center gap-2 transition-colors shadow-sm font-medium">
                        <i data-lucide="printer" class="w-4 h-4"></i> พิมพ์รายงาน
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- VIEW: YEARLY OVERVIEW (Dashboard) -->
        <div id="year-view" class="fade-in">
            
            <!-- Yearly Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">สรุปผลงานภาพรวม ปี 2569</h2>
                    <p class="text-slate-500 mt-1 flex items-center gap-2">
                        สถานะการดึงข้อมูล: <span id="year-loading-status" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-500">รอเริ่มการทำงาน...</span>
                    </p>
                </div>
                <button onclick="loadYearlyData(true)" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium flex items-center gap-1 bg-indigo-50 px-3 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> อัปเดตข้อมูลทั้งปี
                </button>
            </div>

            <!-- Yearly KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-8">
                <!-- Total YTD -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="absolute right-0 top-0 p-4 opacity-5">
                        <i data-lucide="bar-chart-3" class="w-24 h-24"></i>
                    </div>
                    <p class="text-sm font-semibold text-slate-500">ยอดขายรวมทั้งปี (YTD)</p>
                    <h3 class="text-2xl font-bold text-slate-900 mt-2" id="year-total-fyp">-</h3>
                    <p class="text-xs text-slate-400 mt-2">สะสม ม.ค. - ปัจจุบัน</p>
                </div>

                <!-- Target YTD -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">เป้าหมายรวม (YTD)</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-2" id="year-total-target">-</h3>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                            <i data-lucide="target" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="mt-4 w-full bg-slate-100 rounded-full h-1.5">
                        <div id="year-progress-bar" class="bg-purple-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>

                <!-- % Achievement -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">% ความสำเร็จ</p>
                            <h3 class="text-3xl font-bold text-slate-900 mt-1" id="year-percent">-</h3>
                        </div>
                        <div class="p-2 bg-blue-50 rounded-lg text-blue-600">
                            <i data-lucide="pie-chart" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-sm mt-3" id="year-status-text">-</p>
                </div>

                <!-- Best Month -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">เดือนที่ยอดสูงสุด</p>
                            <h3 class="text-xl font-bold text-slate-900 mt-2" id="year-best-month">-</h3>
                        </div>
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                            <i data-lucide="trophy" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-sm text-green-600 font-semibold mt-2" id="year-best-val">-</p>
                </div>
            </div>

            <!-- Yearly Charts & Top Teams -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Trend Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-slate-500"></i>
                        แนวโน้มยอดขายรายเดือน (Monthly Trend)
                    </h3>
                    <div id="year-chart-container" class="h-64 w-full flex items-end justify-between space-x-2 px-2 overflow-x-auto custom-scrollbar pb-2">
                        <!-- Bars injected by JS -->
                        <div class="w-full h-full flex items-center justify-center text-slate-400 text-sm bg-slate-50 rounded-lg">
                            กำลังโหลดข้อมูล...
                        </div>
                    </div>
                </div>

                <!-- Top Teams YTD -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="medal" class="w-5 h-5 text-slate-500"></i>
                        Top 5 ฝ่ายขาย (สะสมทั้งปี)
                    </h3>
                    <div class="flex-1 overflow-y-auto custom-scrollbar max-h-[250px]">
                        <table class="w-full text-left" id="year-top-teams-table">
                            <tbody class="divide-y divide-slate-50 text-sm">
                                <tr><td class="p-4 text-center text-slate-400">รอการคำนวณ...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Month Selection Grid -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="calendar" class="w-5 h-5 text-slate-500"></i>
                    เลือกดูรายละเอียดรายเดือน
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 mb-10">
                    <div id="month-grid-container" class="contents"></div>
                </div>
            </div>
            
             <div class="text-center text-xs text-slate-400 mt-8 border-t border-slate-100 pt-4">
                * ข้อมูลทั้งหมดดึงจาก Google Sheet (ID: 16q3EZt48isOrnvh6s0sET5WQtAPB_zsUXZ2TTUODT5I) แบบ Real-time
            </div>
        </div>

        <!-- VIEW: MONTHLY DETAIL (Hidden by default) -->
        <div id="month-view" class="hidden fade-in">
            
            <!-- Context Header -->
            <div class="flex items-center justify-between mb-6 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-2 rounded-lg shadow-sm text-indigo-600 font-bold text-xl w-12 h-12 flex items-center justify-center border border-indigo-100" id="current-month-badge">
                        -
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-indigo-900" id="current-month-title">กำลังโหลด...</h2>
                        <p class="text-xs text-indigo-600 flex items-center gap-1">
                            <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Tab: <span id="current-tab-name" class="font-mono font-bold">-</span>
                        </p>
                    </div>
                </div>
                <div class="text-right hidden sm:block">
                     <button onclick="retryFetch()" class="text-sm text-indigo-600 hover:text-indigo-800 underline flex items-center gap-1">
                        <i data-lucide="rotate-cw" class="w-3 h-3"></i> รีเฟรชข้อมูล
                     </button>
                </div>
            </div>

            <!-- Monthly KPI Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 print:grid-cols-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="relative">
                        <p class="text-sm font-semibold text-slate-500">ผลงานจริง (FYP)</p>
                        <h3 class="text-2xl font-bold text-slate-900 mt-2" id="kpi-fyp">-</h3>
                        <p class="text-xs text-slate-400 mt-2">ประจำเดือนนี้</p>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">เทียบเป้าหมาย</p>
                            <h3 class="text-2xl font-bold mt-2 text-slate-900" id="kpi-percent">-</h3>
                        </div>
                        <div class="p-2 bg-purple-50 rounded-lg text-purple-600">
                            <i data-lucide="target" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-2 mt-4 overflow-hidden">
                        <div id="progress-bar" class="bg-gray-300 h-2 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">ฝ่าย Active</p>
                            <h3 class="text-2xl font-bold text-slate-900 mt-2" id="kpi-active-units">-</h3>
                        </div>
                        <div class="p-2 bg-emerald-50 rounded-lg text-emerald-600">
                            <i data-lucide="briefcase" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-sm text-slate-500 mt-4" id="kpi-active-desc">-</p>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-semibold text-slate-500">Top Team</p>
                            <h3 class="text-lg font-bold text-slate-900 mt-2 truncate w-full" id="kpi-top-team">-</h3>
                        </div>
                        <div class="p-2 bg-orange-50 rounded-lg text-orange-600">
                            <i data-lucide="award" class="w-5 h-5"></i>
                        </div>
                    </div>
                    <p class="text-sm text-green-600 mt-4 font-semibold" id="kpi-top-val">-</p>
                </div>
            </div>

            <!-- Monthly Chart & Summary -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 print:block mt-6">
                <!-- Summary Text -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col print:border-gray-300 lg:col-span-1">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-slate-500"></i>
                        สรุปสถานะ
                    </h2>
                    
                    <div id="summary-card" class="mb-6 p-4 bg-slate-50 border border-slate-100 rounded-xl">
                        <div class="flex items-center gap-2 mb-1">
                            <i id="summary-icon" data-lucide="loader" class="w-5 h-5 text-slate-600 animate-spin"></i>
                            <span id="summary-title" class="font-bold text-slate-800">กำลังประมวลผล...</span>
                        </div>
                        <p id="summary-desc" class="text-xs text-slate-600 ml-7 leading-relaxed">
                            ระบบกำลังวิเคราะห์ข้อมูล...
                        </p>
                    </div>
                </div>
                
                 <!-- Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">กราฟเปรียบเทียบ Top 5 (Target vs Actual)</h2>
                    <div id="monthly-chart-container" class="h-48 w-full flex items-end justify-start space-x-6 px-2 overflow-x-auto custom-scrollbar pb-2">
                         <div class="w-full h-full flex items-center justify-center text-slate-400 text-sm">Waiting for data...</div>
                    </div>
                </div>
            </div>

            <!-- Monthly Data Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden mt-6 print:shadow-none print:border-gray-300">
                <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-slate-800">รายละเอียดรายฝ่าย (ประจำเดือน)</h2>
                </div>
                
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-collapse" id="data-table">
                        <thead class="bg-slate-50 text-slate-600 text-xs uppercase">
                            <tr>
                                <th class="p-4 font-semibold">อันดับ</th>
                                <th class="p-4 font-semibold">ฝ่ายขาย / ทีม</th>
                                <th class="p-4 font-semibold text-right">เป้าหมาย</th>
                                <th class="p-4 font-semibold text-right">ผลงานจริง</th>
                                <th class="p-4 font-semibold text-center">%</th>
                                <th class="p-4 font-semibold text-center">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 bg-white" id="table-body">
                            <!-- Data Rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Logic -->
    <script>
        // CONFIG
        const SHEET_ID = '16q3EZt48isOrnvh6s0sET5WQtAPB_zsUXZ2TTUODT5I';
        const MONTHS = [
            { name: "มกราคม", full: "มกราคม", short: "ม.ค." }, // Tab Name Must Match "name"
            { name: "ก.พ.", full: "กุมภาพันธ์", short: "ก.พ." }, 
            { name: "มี.ค.", full: "มีนาคม", short: "มี.ค." }, 
            { name: "เม.ย.", full: "เมษายน", short: "เม.ย." }, 
            { name: "พ.ค.", full: "พฤษภาคม", short: "พ.ค." }, 
            { name: "มิ.ย.", full: "มิถุนายน", short: "มิ.ย." }, 
            { name: "ก.ค.", full: "กรกฎาคม", short: "ก.ค." }, 
            { name: "ส.ค.", full: "สิงหาคม", short: "ส.ค." }, 
            { name: "ก.ย.", full: "กันยายน", short: "ก.ย." }, 
            { name: "ต.ค.", full: "ตุลาคม", short: "ต.ค." }, 
            { name: "พ.ย.", full: "พฤศจิกายน", short: "พ.ย." }, 
            { name: "ธ.ค.", full: "ธันวาคม", short: "ธ.ค." }
        ];

        // Global State & Cache
        let currentSheetName = "";
        let yearDataCache = new Array(12).fill(null); // Cache for monthly totals
        let isYearlyLoaded = false;
        let cumulativeTeams = {}; // Map team name -> {target, actual}

        // Utils
        const formatCurrency = (num) => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', maximumFractionDigits: 0 }).format(num);
        const formatNum = (num) => new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(num);
        const safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; }

        function initYearView() {
            // Render Month Grid
            const grid = document.getElementById('month-grid-container');
            let gridHtml = '';

            MONTHS.forEach((m, i) => {
                gridHtml += `
                    <div onclick="openMonth(${i})" class="bg-white text-slate-700 border border-slate-200 shadow-sm rounded-lg p-4 hover:border-indigo-500 hover:shadow-md cursor-pointer group transition-all relative select-none">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400 uppercase">Month ${i+1}</span>
                            <i data-lucide="bar-chart-2" class="w-4 h-4 text-slate-300 group-hover:text-indigo-500"></i>
                        </div>
                        <h3 class="text-lg font-bold group-hover:text-indigo-600 transition-colors">${m.short}</h3>
                        <p class="text-[10px] opacity-70">2569</p>
                    </div>
                `;
            });
            grid.innerHTML = gridHtml;
            lucide.createIcons();
            
            // Auto Load Yearly Data
            loadYearlyData();
        }

        async function loadYearlyData(forceRefresh = false) {
            if (isYearlyLoaded && !forceRefresh) return;
            
            const statusEl = document.getElementById('year-loading-status');
            const progressEl = document.getElementById('year-chart-container');
            
            statusEl.innerText = "กำลังดึงข้อมูลจากทุกเดือน...";
            statusEl.className = "text-xs font-mono bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded";
            
            cumulativeTeams = {}; // Reset cumulative
            let processedCount = 0;
            
            // Process sequentially to be gentle
            for (let i = 0; i < MONTHS.length; i++) {
                const sheetName = MONTHS[i].name;
                
                try {
                    // Fetch if not in cache or forced
                    let data = yearDataCache[i];
                    if (!data || forceRefresh) {
                         const rawData = await fetchSheetData(sheetName);
                         data = processSheetData(rawData);
                         yearDataCache[i] = data; // Cache it
                    }
                    
                    // Aggregate for Year Totals
                    if(data.totalActual > 0 || data.totalTarget > 0) {
                         // Accumulate Team Data for Top Ranking
                         data.teams.forEach(t => {
                             if(!cumulativeTeams[t.name]) cumulativeTeams[t.name] = { name: t.name, target: 0, actual: 0 };
                             cumulativeTeams[t.name].target += t.target;
                             cumulativeTeams[t.name].actual += t.actual;
                         });
                    }

                    processedCount++;
                    updateYearlyUI(); // Incremental update

                } catch (err) {
                    console.warn(`Skipping month ${sheetName}: ${err.message}`);
                    yearDataCache[i] = { totalTarget: 0, totalActual: 0, activeCount: 0, teams: [] }; // Empty placeholder
                }
            }
            
            isYearlyLoaded = true;
            statusEl.innerText = "อัปเดตเรียบร้อย";
            statusEl.className = "text-xs font-mono bg-green-100 text-green-700 px-2 py-0.5 rounded";
        }

        function updateYearlyUI() {
            let yearTarget = 0;
            let yearActual = 0;
            let maxMonthVal = 0;
            let bestMonthName = "-";

            // Calculate Totals & Chart Data
            let chartHtml = '';
            
            // Determine max value for chart scaling
            const allVals = yearDataCache.map(d => d ? Math.max(d.totalTarget, d.totalActual) : 0);
            const globalMax = Math.max(...allVals, 1);

            yearDataCache.forEach((d, i) => {
                if (!d) return; // Skip if not loaded yet
                
                yearTarget += d.totalTarget;
                yearActual += d.totalActual;

                if (d.totalActual > maxMonthVal) {
                    maxMonthVal = d.totalActual;
                    bestMonthName = MONTHS[i].full;
                }

                // Chart Bar
                const hTarget = (d.totalTarget / globalMax) * 100;
                const hActual = (d.totalActual / globalMax) * 100;
                const color = d.totalActual >= d.totalTarget && d.totalTarget > 0 ? 'bg-green-500' : 'bg-indigo-400';
                const opacity = d.totalActual === 0 && d.totalTarget === 0 ? 'opacity-30' : 'opacity-100';

                chartHtml += `
                <div class="flex flex-col items-center justify-end h-full group min-w-[30px] flex-1 ${opacity} hover:opacity-100 transition-opacity cursor-pointer" onclick="openMonth(${i})">
                    <div class="relative w-full flex justify-center items-end h-[85%] space-x-0.5 px-0.5">
                        <div class="w-1/2 bg-slate-200 rounded-t-sm" style="height: ${hTarget}%" title="เป้า ${MONTHS[i].short}: ${formatNum(d.totalTarget)}"></div>
                        <div class="w-1/2 ${color} rounded-t-sm" style="height: ${hActual}%" title="จริง ${MONTHS[i].short}: ${formatNum(d.totalActual)}"></div>
                    </div>
                    <div class="h-[15%] flex items-start pt-2 w-full justify-center">
                         <p class="text-[10px] text-slate-500 truncate text-center">${MONTHS[i].short}</p>
                    </div>
                </div>`;
            });

            // Update Cards
            safeSetText('year-total-fyp', formatNum(yearActual));
            safeSetText('year-total-target', formatNum(yearTarget));
            safeSetText('year-best-month', bestMonthName);
            safeSetText('year-best-val', formatCurrency(maxMonthVal));

            const percent = yearTarget > 0 ? (yearActual / yearTarget) * 100 : 0;
            safeSetText('year-percent', percent.toFixed(1) + '%');
            
            const progBar = document.getElementById('year-progress-bar');
            if(progBar) progBar.style.width = Math.min(percent, 100) + '%';
            
            const statusText = document.getElementById('year-status-text');
            if(percent >= 100) {
                statusText.innerText = "ยอดเยี่ยม! ทะลุเป้าหมายรวม";
                statusText.className = "text-sm mt-3 text-green-600 font-bold";
                progBar.className = "bg-green-500 h-1.5 rounded-full transition-all duration-1000";
            } else if (percent >= 80) {
                 statusText.innerText = "อยู่ในเกณฑ์ดี";
                 statusText.className = "text-sm mt-3 text-purple-600 font-bold";
                 progBar.className = "bg-purple-500 h-1.5 rounded-full transition-all duration-1000";
            } else {
                 statusText.innerText = "ต่ำกว่าเป้าหมาย";
                 statusText.className = "text-sm mt-3 text-red-500 font-bold";
                 progBar.className = "bg-red-500 h-1.5 rounded-full transition-all duration-1000";
            }

            // Update Chart Container
            const chartCont = document.getElementById('year-chart-container');
            if(chartCont) chartCont.innerHTML = chartHtml;

            // Update Top Teams Table
            const sortedTeams = Object.values(cumulativeTeams).sort((a,b) => b.actual - a.actual).slice(0, 5);
            const teamTable = document.getElementById('year-top-teams-table');
            let tableHtml = "";
            sortedTeams.forEach((t, idx) => {
                const tp = t.target > 0 ? (t.actual / t.target) * 100 : 0;
                tableHtml += `
                    <tr class="border-b border-slate-50 last:border-none">
                        <td class="py-3 px-2 flex items-center gap-3">
                            <span class="w-6 h-6 rounded-full bg-slate-100 text-slate-600 text-xs font-bold flex items-center justify-center">${idx+1}</span>
                            <div>
                                <div class="font-medium text-slate-800 text-sm">${t.name}</div>
                                <div class="text-xs text-slate-400">Target: ${formatNum(t.target)}</div>
                            </div>
                        </td>
                        <td class="py-3 px-2 text-right">
                            <div class="font-bold text-slate-700 text-sm">${formatNum(t.actual)}</div>
                            <div class="text-[10px] ${tp >= 100 ? 'text-green-500' : 'text-slate-400'}">${tp.toFixed(0)}%</div>
                        </td>
                    </tr>
                `;
            });
            if(sortedTeams.length === 0) tableHtml = `<tr><td class="p-4 text-center text-slate-400 text-sm">ไม่มีข้อมูล</td></tr>`;
            if(teamTable) teamTable.innerHTML = tableHtml;
        }


        // --- Monthly Logic ---

        function showYearView() {
            document.getElementById('year-view').classList.remove('hidden');
            document.getElementById('month-view').classList.add('hidden');
            document.getElementById('btn-back').classList.add('hidden');
            window.scrollTo(0, 0);
        }

        async function openMonth(index) {
            const m = MONTHS[index];
            currentSheetName = m.name;
            
            // Switch View
            document.getElementById('year-view').classList.add('hidden');
            document.getElementById('month-view').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            
            // Set Header
            safeSetText('current-month-badge', m.short);
            safeSetText('current-month-title', `${m.full} 2569`);
            safeSetText('current-tab-name', m.name);

            // Check Cache first
            if (yearDataCache[index] && yearDataCache[index].teams.length > 0) {
                 updateMonthUI(yearDataCache[index]);
                 // Fetch transparently to update if needed
                 fetchSingleMonth(m.name, index); 
            } else {
                 await fetchSingleMonth(m.name, index);
            }
            window.scrollTo(0, 0);
        }

        async function fetchSingleMonth(sheetName, index) {
             const loading = document.getElementById('loading');
             loading.classList.remove('hidden');
             try {
                 const rawData = await fetchSheetData(sheetName);
                 const processed = processSheetData(rawData);
                 yearDataCache[index] = processed; // Update Cache
                 updateMonthUI(processed);
             } catch(e) {
                 handleFetchError(e, sheetName);
             } finally {
                 loading.classList.add('hidden');
             }
        }
        
        function retryFetch() {
            if(currentSheetName) fetchSingleMonth(currentSheetName, MONTHS.findIndex(m => m.name === currentSheetName));
        }

        // --- Core Fetching ---
        
        async function fetchSheetData(sheetName) {
            const cacheBuster = new Date().getTime();
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&_=${cacheBuster}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            
            const jsonStart = text.indexOf("{");
            const jsonEnd = text.lastIndexOf("}") + 1;
            if (jsonStart === -1) throw new Error("Invalid JSON response");
            
            const json = JSON.parse(text.substring(jsonStart, jsonEnd));
            if (json.status === 'error') throw new Error(json.errors[0].detailed_message);
            
            return json;
        }

        function processSheetData(json) {
            const rows = json.table.rows;
            let teams = [];
            let totalTarget = 0;
            let totalActual = 0;
            let activeCount = 0;

            rows.forEach((row) => {
                if (!row.c || !row.c[0]) return;
                const name = row.c[0]?.v ? String(row.c[0].v) : "";
                const branch = row.c[1]?.v ? String(row.c[1].v) : "-";
                
                let targetStr = row.c[2]?.v ? String(row.c[2].v).replace(/,/g, '') : "0";
                let actualStr = row.c[3]?.v ? String(row.c[3].v).replace(/,/g, '') : "0";
                
                const target = parseFloat(targetStr) || 0;
                const actual = parseFloat(actualStr) || 0;

                if (isNaN(target) && isNaN(actual)) return;
                if (name.includes("รวม") || name.includes("Total") || name.includes("ชื่อฝ่าย") || name === "Name") return;

                if (actual > 0) activeCount++;
                totalTarget += target;
                totalActual += actual;
                teams.push({ name, branch, target, actual });
            });

            teams.sort((a, b) => b.actual - a.actual);
            return { teams, totalTarget, totalActual, activeCount };
        }

        function updateMonthUI(data) {
            const { teams, totalTarget, totalActual, activeCount } = data;
            
            // KPI
            safeSetText('kpi-fyp', formatNum(totalActual));
            safeSetText('kpi-percent', totalTarget > 0 ? ((totalActual/totalTarget)*100).toFixed(1) + '%' : '0%');
            safeSetText('kpi-active-units', `${activeCount} / ${teams.length}`);
            
            if(teams.length > 0) {
                 safeSetText('kpi-top-team', teams[0].name);
                 safeSetText('kpi-top-val', formatCurrency(teams[0].actual));
            }

            // Summary Card
            const percent = totalTarget > 0 ? (totalActual / totalTarget) * 100 : 0;
            const summaryTitle = document.getElementById('summary-title');
            const summaryIcon = document.getElementById('summary-icon');
            const summaryDesc = document.getElementById('summary-desc');
            const summaryCard = document.getElementById('summary-card');

            if (percent >= 100) {
                summaryCard.className = "mb-6 p-4 bg-green-50 border border-green-100 rounded-xl";
                summaryTitle.innerText = "ยอดเยี่ยม (ทะลุเป้า)";
                summaryIcon.className = "w-5 h-5 text-green-600";
                summaryIcon.setAttribute('data-lucide', 'trophy');
            } else if (percent >= 80) {
                summaryCard.className = "mb-6 p-4 bg-yellow-50 border border-yellow-100 rounded-xl";
                summaryTitle.innerText = "ใกล้เคียงเป้าหมาย";
                summaryIcon.className = "w-5 h-5 text-yellow-600";
                summaryIcon.setAttribute('data-lucide', 'trending-up');
            } else {
                summaryCard.className = "mb-6 p-4 bg-red-50 border border-red-100 rounded-xl";
                summaryTitle.innerText = "ต่ำกว่าเกณฑ์";
                summaryIcon.className = "w-5 h-5 text-red-600";
                summaryIcon.setAttribute('data-lucide', 'alert-circle');
            }
            lucide.createIcons();

            // Table
            const tbody = document.getElementById('table-body');
            let tableHtml = '';
            teams.forEach((team, index) => {
                const p = team.target > 0 ? (team.actual / team.target) * 100 : 0;
                let statusBadge = p >= 100 ? `<span class="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs font-bold">เข้าเป้า</span>` :
                                  p >= 70 ? `<span class="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs">ใกล้เคียง</span>` :
                                  `<span class="bg-red-100 text-red-800 px-2 py-0.5 rounded text-xs">ต่ำกว่า</span>`;

                tableHtml += `
                    <tr class="hover:bg-indigo-50/30 transition-colors border-b border-slate-50 last:border-none">
                        <td class="p-4 text-sm text-slate-500 font-mono">${index + 1}</td>
                        <td class="p-4 text-sm font-medium text-slate-900">${team.name} <span class="text-xs text-slate-400 block">${team.branch}</span></td>
                        <td class="p-4 text-sm text-slate-500 text-right font-mono">${formatNum(team.target)}</td>
                        <td class="p-4 text-sm text-slate-900 font-semibold text-right font-mono">${formatNum(team.actual)}</td>
                        <td class="p-4 text-sm text-center font-medium ${p >= 100 ? 'text-green-600' : ''}">${p.toFixed(0)}%</td>
                        <td class="p-4 text-center">${statusBadge}</td>
                    </tr>
                `;
            });
            if (teams.length === 0) tableHtml = '<tr><td colspan="6" class="p-8 text-center text-slate-400">ไม่พบข้อมูล</td></tr>';
            tbody.innerHTML = tableHtml;
        }

        function handleFetchError(error, sheetName) {
            console.error(error);
            const modal = document.getElementById('error-modal');
            safeSetText('error-detail', `ไม่สามารถดึงข้อมูล "${sheetName}"`);
            safeSetText('error-tech', error.message);
            modal.classList.remove('hidden');
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initYearView();
        });

    </script>
</body>
</html>
